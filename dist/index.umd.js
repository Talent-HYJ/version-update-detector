!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VersionUpdateDetector={})}(this,function(e){"use strict";class t{constructor(e={}){this.timer=null,this.isChecking=!1,this.onUpdateCallbacks=[],this.onResourceErrorCallbacks=[],this.currentVersion=window.version||"1.0.0",this.options={checkInterval:18e5,skipInDevelopment:!0,isDevelopment:()=>this.detectLocalEnvironment(),versionCheckUrl:"/package.json",enableResourceErrorDetection:!0,...e},this.checkInterval=this.options.checkInterval,this.isLocalDevelopment=this.options.isDevelopment(),this.init()}init(){this.isLocalDevelopment&&this.options.skipInDevelopment?console.log("检测到本地开发环境，跳过版本检测"):(this.options.enableResourceErrorDetection&&this.listenResourceErrors(),this.startVersionCheck())}detectLocalEnvironment(){const e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||"0.0.0.0"===window.location.hostname,t="undefined"!=typeof process&&process.env&&"development"===process.env.NODE_ENV,n=e||t;return console.log("开发环境检测:",{isLocalhost:e,isNodeEnvDev:t,isDev:n}),n}listenResourceErrors(){window.addEventListener("error",e=>{if(e.target!==window){const t=e.target;t.tagName&&("script"===t.tagName.toLowerCase()||"link"===t.tagName.toLowerCase()||"img"===t.tagName.toLowerCase())&&(console.warn("资源加载失败:",t.src||t.href),this.handleResourceError(t))}},!0),window.addEventListener("unhandledrejection",e=>{var t,n;e.reason&&((null===(t=e.reason.message)||void 0===t?void 0:t.includes("Loading chunk"))||(null===(n=e.reason.message)||void 0===n?void 0:n.includes("Failed to fetch"))||"ECONNABORTED"===e.reason.code)&&(console.warn("网络请求失败，可能是版本更新导致:",e.reason),this.handleResourceError())})}async handleResourceError(e){if(this.isLocalDevelopment&&this.options.skipInDevelopment)return void console.log("本地开发环境，忽略资源加载错误");await new Promise(e=>setTimeout(e,1e3));await this.checkForUpdate()&&this.onResourceErrorCallbacks.forEach(t=>{try{t(e)}catch(e){console.error("Resource error callback error:",e)}})}startVersionCheck(){this.isLocalDevelopment&&this.options.skipInDevelopment?console.log("本地开发环境，跳过版本检查启动"):(this.timer&&clearInterval(this.timer),setTimeout(()=>this.checkForUpdate(),5e3),this.timer=setInterval(()=>{this.checkForUpdate()},this.checkInterval))}stopVersionCheck(){this.timer&&(clearInterval(this.timer),this.timer=null)}async checkForUpdate(){if(this.isLocalDevelopment&&this.options.skipInDevelopment)return!1;if(this.isChecking)return!1;this.isChecking=!0;try{if(await this.checkVersionByPackage())return!0;if(await this.checkVersionByIndex())return!0}catch(e){console.warn("版本检查失败:",e);try{await fetch("/",{method:"HEAD",cache:"no-cache"})}catch(e){return this.notifyUpdate("network-error"),!0}}finally{this.isChecking=!1}return!1}async checkVersionByPackage(){try{const e=await fetch(`${this.options.versionCheckUrl}?${Date.now()}`,{cache:"no-cache"});if(e.ok){const t=(await e.json()).version,n=e.headers.get("etag"),o=e.headers.get("last-modified"),i=localStorage.getItem("app_package_info");if(!i){const e={version:t,etag:n||void 0,lastModified:o||void 0,checkTime:Date.now()};return localStorage.setItem("app_package_info",JSON.stringify(e)),!1}const s=JSON.parse(i),r=t&&t!==s.version,a=n&&n!==s.etag,c=o&&o!==s.lastModified;if(r||a||c){const e={version:t,etag:n||void 0,lastModified:o||void 0,checkTime:Date.now()};localStorage.setItem("app_package_info",JSON.stringify(e));const i=r?"version-change":"redeploy";return this.notifyUpdate(i),!0}}}catch(e){console.warn("无法获取package.json:",e)}return!1}async checkVersionByIndex(){try{const e=await fetch(`/index.html?${Date.now()}`,{method:"HEAD",cache:"no-cache"});if(e.ok){const t=e.headers.get("etag"),n=e.headers.get("last-modified"),o=localStorage.getItem("app_index_etag"),i=localStorage.getItem("app_index_last_modified");if(!o&&!i)return t&&localStorage.setItem("app_index_etag",t),n&&localStorage.setItem("app_index_last_modified",n),!1;if(t&&t!==o||n&&n!==i)return t&&localStorage.setItem("app_index_etag",t),n&&localStorage.setItem("app_index_last_modified",n),this.notifyUpdate("redeploy"),!0}}catch(e){console.warn("无法检查index.html:",e)}return!1}notifyUpdate(e="unknown"){console.log("检测到应用更新, 原因:",e),this.onUpdateCallbacks.forEach(t=>{try{t(e)}catch(e){console.error("Update callback error:",e)}})}onUpdate(e){"function"==typeof e&&this.onUpdateCallbacks.push(e)}onResourceError(e){"function"==typeof e&&this.onResourceErrorCallbacks.push(e)}removeCallback(e){const t=this.onUpdateCallbacks.indexOf(e);t>-1&&this.onUpdateCallbacks.splice(t,1);const n=this.onResourceErrorCallbacks.indexOf(e);n>-1&&this.onResourceErrorCallbacks.splice(n,1)}destroy(){this.stopVersionCheck(),this.onUpdateCallbacks=[],this.onResourceErrorCallbacks=[]}setDevelopmentMode(e){this.isLocalDevelopment=e,e?(console.log("手动设置为开发模式，停止版本检测"),this.stopVersionCheck()):(console.log("手动设置为生产模式，重新启动版本检测"),this.init())}isDevelopment(){return this.isLocalDevelopment}reload(){"serviceWorker"in navigator?navigator.serviceWorker.getRegistrations().then(e=>{e.forEach(e=>e.unregister()),setTimeout(()=>window.location.reload(),100)}):window.location.reload()}}class n{constructor(e={},t={}){this.container=null,this.isVisible=!1,this.refreshing=!1,this.laterTimestamp=0,this.options={title:"应用更新提醒",description:"请刷新页面以获得最新内容。",showClose:!1,closeOnClickModal:!1,closeOnPressEscape:!1,forceUpdate:!1,customClass:"update-notification-dialog",width:"480px",center:!0,buttonText:{later:"稍后提醒",refresh:"立即刷新",refreshing:"正在刷新..."},laterInterval:6e5,customStyles:{},...e},this.events=t,this.init()}init(){this.createContainer(),this.bindEvents()}createContainer(){const e=document.createElement("div");e.className="update-notification-overlay",e.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background-color: rgba(0, 0, 0, 0.5);\n      z-index: 9999;\n      display: none;\n    ",this.container=document.createElement("div"),this.container.className=`update-notification-dialog ${this.options.customClass}`,this.container.style.cssText=`\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      width: ${this.options.width};\n      max-width: 90%;\n      background: white;\n      border-radius: 8px;\n      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n      z-index: 10000;\n      display: none;\n    `,this.options.customStyles.container&&(this.container.style.cssText+=this.options.customStyles.container),e.appendChild(this.container),document.body.appendChild(e)}bindEvents(){if(this.container&&(this.options.closeOnPressEscape&&document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isVisible&&this.hide()}),this.options.closeOnClickModal)){const e=this.container.parentElement;e&&e.addEventListener("click",t=>{t.target===e&&this.hide()})}}show(e="unknown",t=!1){const n=Date.now();if("resource-error"!==e&&this.laterTimestamp&&n-this.laterTimestamp<this.options.laterInterval)return;if(!this.container)return;this.isVisible=!0,this.refreshing=!1,this.updateContent(e,t);const o=this.container.parentElement;o&&(o.style.display="block",this.container.style.display="block"),requestAnimationFrame(()=>{this.container&&(this.container.style.opacity="0",this.container.style.transform="translate(-50%, -50%) scale(0.8)",requestAnimationFrame(()=>{this.container&&(this.container.style.transition="all 0.3s ease",this.container.style.opacity="1",this.container.style.transform="translate(-50%, -50%) scale(1)")}))})}hide(){var e,t;this.container&&(this.isVisible=!1,this.refreshing=!1,this.container&&(this.container.style.transition="all 0.3s ease",this.container.style.opacity="0",this.container.style.transform="translate(-50%, -50%) scale(0.8)"),setTimeout(()=>{var e;const t=null===(e=this.container)||void 0===e?void 0:e.parentElement;t&&(t.style.display="none"),this.container&&(this.container.style.display="none")},300),null===(t=(e=this.events).onClose)||void 0===t||t.call(e))}updateContent(e,t){if(!this.container)return;const{title:n,description:o,icon:i}=this.getContentByReason(e,t),s=t||"resource-error"===e;this.container.innerHTML=`\n      <div class="update-notification-content" style="padding: 20px;">\n        <div class="update-notification-header" style="text-align: center; margin-bottom: 20px;">\n          <div class="update-notification-icon" style="margin-bottom: 16px;">\n            <i class="update-icon" style="\n              display: inline-block;\n              width: 48px;\n              height: 48px;\n              background: #409eff;\n              border-radius: 50%;\n              color: white;\n              font-size: 24px;\n              line-height: 48px;\n              text-align: center;\n              animation: rotate 2s linear infinite;\n            ">${i}</i>\n          </div>\n          <h3 style="\n            margin: 0 0 16px 0;\n            color: #303133;\n            font-weight: 600;\n            font-size: 20px;\n          ">${n}</h3>\n          <p style="\n            margin: 0 0 16px 0;\n            color: #606266;\n            font-size: 14px;\n            line-height: 1.6;\n          ">${o}</p>\n          ${this.getErrorDetails(e)}\n        </div>\n        <div class="update-notification-footer" style="\n          text-align: right;\n          border-top: 1px solid #ebeef5;\n          padding-top: 20px;\n        ">\n          ${s?"":`\n            <button class="later-btn" style="\n              margin-right: 10px;\n              padding: 8px 16px;\n              border: 1px solid #dcdfe6;\n              border-radius: 4px;\n              background: white;\n              color: #606266;\n              cursor: pointer;\n              font-size: 14px;\n            ">${this.options.buttonText.later}</button>\n          `}\n          <button class="refresh-btn" style="\n            padding: 8px 16px;\n            border: 1px solid #409eff;\n            border-radius: 4px;\n            background: #409eff;\n            color: white;\n            cursor: pointer;\n            font-size: 14px;\n          ">${this.refreshing?this.options.buttonText.refreshing:this.options.buttonText.refresh}</button>\n        </div>\n      </div>\n      <style>\n        @keyframes rotate {\n          from { transform: rotate(0deg); }\n          to { transform: rotate(360deg); }\n        }\n        .update-notification-dialog {\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n        }\n        .later-btn:hover {\n          background: #f5f7fa;\n        }\n        .refresh-btn:hover {\n          background: #66b1ff;\n        }\n        .refresh-btn:disabled {\n          background: #a0cfff;\n          cursor: not-allowed;\n        }\n      </style>\n    `,this.bindButtonEvents()}getContentByReason(e,t){switch(e){case"version-change":return{title:"发现新版本",description:"为了获得更好的使用体验，请刷新页面更新到最新版本。",icon:"↻"};case"resource-error":return{title:"应用已更新",description:"请刷新页面以获得最新内容。",icon:"⚠"};case"network-error":return{title:"网络连接异常",description:"网络连接异常，建议刷新页面重试。",icon:"⚠"};default:return{title:"应用已更新",description:"请刷新页面以获得最新内容。",icon:"↻"}}}getErrorDetails(e){return"resource-error"===e?'\n        <div style="\n          margin-top: 16px;\n          padding: 12px;\n          border: 1px solid #fbc4c4;\n          border-radius: 4px;\n          background-color: #fef0f0;\n          color: #f56c6c;\n          font-size: 14px;\n        ">\n          <span style="margin-right: 8px;">⚠</span>\n          检测到部分资源加载失败，可能影响正常使用\n        </div>\n      ':"network-error"===e?'\n        <div style="\n          margin-top: 16px;\n          padding: 12px;\n          border: 1px solid #fbc4c4;\n          border-radius: 4px;\n          background-color: #fef0f0;\n          color: #f56c6c;\n          font-size: 14px;\n        ">\n          <span style="margin-right: 8px;">⚠</span>\n          网络连接异常，建议刷新页面重试\n        </div>\n      ':""}bindButtonEvents(){if(!this.container)return;const e=this.container.querySelector(".later-btn"),t=this.container.querySelector(".refresh-btn");e&&e.addEventListener("click",()=>{this.handleLater()}),t&&t.addEventListener("click",()=>{this.handleRefresh()})}handleRefresh(){var e,t,n;this.refreshing=!0,null===(t=(e=this.events).onRefresh)||void 0===t||t.call(e);const o=null===(n=this.container)||void 0===n?void 0:n.querySelector(".refresh-btn");o&&(o.disabled=!0,o.textContent=this.options.buttonText.refreshing||"正在刷新..."),setTimeout(()=>{this.refreshing&&window.location.reload()},5e3)}handleLater(){var e,t;this.laterTimestamp=Date.now(),this.hide(),null===(t=(e=this.events).onLater)||void 0===t||t.call(e)}destroy(){if(this.container){const e=this.container.parentElement;e&&document.body.removeChild(e),this.container=null}}isNotificationVisible(){return this.isVisible}}function o(e={},o={},i={}){const s=new t(e),r=new n(o,i);return s.onUpdate(e=>{r.show(e)}),s.onResourceError(()=>{r.show("resource-error",!0)}),{detector:s,notification:r,destroy:()=>{s.destroy(),r.destroy()}}}var i={VersionDetector:t,UpdateNotification:n,createVersionUpdateDetector:o};e.UpdateNotification=n,e.VersionDetector=t,e.createVersionUpdateDetector=o,e.default=i,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.umd.js.map
